{% extends "base.html" %}
{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../static/CesiumUnminified/Cesium.js"></script>
    <style>
        @import url(../static/CesiumUnminified/Widgets/widgets.css);

        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/trajectory.css">
{% endblock %}
{% block title %}Траектория спутника{% endblock %}
{% block content %}

    <div class="background">
        <div class="times-container">
            <div>
                <p>Начало пролета (UTC)</p>
                <p id="start-time"></p>
            </div>
            <div>
                <p>Конец пролета (UTC)</p>
                <p id="end-time"></p>
            </div>
            <div>
                <p>Азимут</p>
                <p id="azimuth"></p>
            </div>
            <div>
                <p>Элевация</p>
                <p id="elevation"></p>
            </div>
        </div>
    </div>

    <div class="maps-container">
        <div id="cesiumContainer"></div>
    </div>

    <script>
        axios.get('/get-pass-trajectory').then(response => {
            const positions = response.data.absolute_trajectory.map(coords => Cesium.Cartesian3.fromDegrees(...coords));
            const lon = response.data.lon;
            const lat = response.data.lat;
            const startTime = response.data.start_time;
            const endTime = response.data.end_time;

            document.getElementById('start-time').innerHTML = startTime;
            document.getElementById('end-time').innerHTML = endTime;

            const viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                timeline: false,
                fullscreenButton: false
            });

            const satellitePathEntity = viewer.entities.add({
                polyline: {
                    positions: positions,
                    width: 2,
                    material: Cesium.Color.RED
                }
            });

            const userPoint = viewer.scene.primitives.add(new Cesium.PointPrimitiveCollection()).add({
                position: Cesium.Cartesian3.fromDegrees(lon, lat, 0),
                color: Cesium.Color.BLUE,
                pixelSize: 15,
            });

            const satellitePoint = viewer.scene.primitives.add(new Cesium.PointPrimitiveCollection()).add({
                position: positions[0],
                color: Cesium.Color.RED,
                pixelSize: 15,
            });

            setInterval(async () => {
                const response = await axios.get('/get-viewer-coords');

                if (response.data.error) {
                    document.getElementById('azimuth').innerHTML = 'Пролет еще не начался или уже закончился';
                    document.getElementById('elevation').innerHTML = 'Пролет еще не начался или уже закончился';
                    return;
                }

                document.getElementById('azimuth').innerHTML = response.data.azimuth;
                document.getElementById('elevation').innerHTML = response.data.elevation;

                satellitePoint.position = Cesium.Cartesian3.fromDegrees(response.data.lat, response.data.lon, 0);
            }, 1000);
        }).catch(error => console.error(error));
    </script>

{% endblock %}